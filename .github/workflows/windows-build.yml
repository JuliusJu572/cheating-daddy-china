name: CI Desktop

on:
    pull_request:
        branches: [main]
    schedule:
        - cron: '0 2 2 */4 *'
    workflow_dispatch:

permissions:
    contents: read

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        strategy:
            fail-fast: true
            matrix:
                os: [windows-latest, macos-latest, ubuntu-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Setup NodeJS
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run tests
              run: npm test
              continue-on-error: true

            - name: Build app (Windows)
              if: matrix.os == 'windows-latest'
              run: npm run make -- --platform=win32

            - name: Build app (macOS)
              if: matrix.os == 'macos-latest'
              run: npm run make -- --platform=darwin

            - name: Build app (Linux)
              if: matrix.os == 'ubuntu-latest'
              run: npm run make -- --platform=linux

            - name: List build output
              run: |
                echo "Build output files:"
                ls -R out/make || dir /s /b out\make
              shell: bash

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-${{ matrix.os }}
                  path: |
                      out/make/**/*.exe
                      out/make/**/*.dmg
                      out/make/**/*.deb
                      out/make/**/*.rpm
                  if-no-files-found: warn